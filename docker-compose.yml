services:
  # ===== BASE DE DONNÉES =====
  postgres:
    image: postgres:14
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-oppsys}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - oppsys-network
    restart: unless-stopped

  # ===== REDIS MCP MEMORY =====
  redis:
    image: redis:7-alpine
    container_name: redis
    restart: unless-stopped
    command: >
      redis-server
      --requirepass ${REDIS_PASSWORD:xxxxxxxxxxxxxxxxxxxx}
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --appendonly yes
      --appendfsync everysec
      --bind 0.0.0.0
      --protected-mode yes
    environment:
      - REDIS_PASSWORD=${REDIS_PASSWORD:xxxxxxxxxxxxxxxxxxxx}
    volumes:
      - redis_mcp_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - oppsys-network
      - n8n-stack-network
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"
        reservations:
          memory: 128M
          cpus: "0.2"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", xxxxxxxxxxxxxxxxxxxx", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3

    # ===== GOTENBERG PDF CONVERTER =====
  gotenberg:
    image: gotenberg/gotenberg:8
    container_name: gotenberg
    restart: unless-stopped
    environment:
      - CHROMIUM_DISABLE_ROUTES=false
      - CHROMIUM_INCOGNITO=true
      - CHROMIUM_ALLOW_LIST=^file:///tmp/.*
      - API_TIMEOUT=120s
      - API_PORT=3000
      - LOG_LEVEL=info
      - CHROMIUM_MAX_QUEUE_SIZE=50
      - CHROMIUM_AUTO_START=true
      - DISABLE_GOOGLE_CHROME_FIRST_RUN=true
      - DISABLE_GOOGLE_CHROME_BACKGROUND_NETWORKING=true
    networks:
      - oppsys-network
      - n8n-stack-network
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "1.0"
        reservations:
          memory: 512M
          cpus: "0.25"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    ulimits:
      nofile:
        soft: 4096
        hard: 8192
    tmpfs:
      - /tmp:size=512M,mode=1777

  # ===== WEBSITE MARKETING (Next.js) =====
  oppsys-website:
    build:
      context: .
      dockerfile: apps/website/Dockerfile
      args:
        NODE_ENV: ${NODE_ENV:-production}
        #  Next.js : Variables NEXT_PUBLIC_ passées au build
        NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        NEXT_PUBLIC_APP_URL: ${NEXT_PUBLIC_APP_URL}
        NEXT_PUBLIC_ADMIN_URL: ${NEXT_PUBLIC_ADMIN_URL}
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_SITE_URL: ${NEXT_PUBLIC_SITE_URL}
        NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: ${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      #  Next.js : Variables d'environnement pour le runtime
      - NEXT_PUBLIC_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - NEXT_PUBLIC_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - NEXT_PUBLIC_APP_URL=${NEXT_PUBLIC_APP_URL}
      - NEXT_PUBLIC_ADMIN_URL=${NEXT_PUBLIC_ADMIN_URL}
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - NEXT_PUBLIC_SITE_URL=${NEXT_PUBLIC_SITE_URL}
      - NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=${NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY}
    ports:
      - "3000:3000"
    networks:
      - oppsys-network
    restart: unless-stopped
    depends_on:
      - oppsys-api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.website.rule=Host(`oppsys.io`) || Host(`www.oppsys.io`)"
      - "traefik.http.routers.website.entrypoints=websecure"
      - "traefik.http.routers.website.tls.certresolver=letsencrypt"
      - "traefik.http.services.website.loadbalancer.server.port=xxxxxxxxxxxxxxxxxxxx"
      - "traefik.docker.network=docker_oppsys-network"
      # Redirection www vers apex domain
      - "traefik.http.middlewares.website-redirect.redirectregex.regex=^https://www\\.oppsys\\.io(.*)"
      - "traefik.http.middlewares.website-redirect.redirectregex.replacement=https://oppsys.io$${1}"
      - "traefik.http.middlewares.website-redirect.redirectregex.permanent=true"
      - "traefik.http.routers.website.middlewares=website-redirect"

  # ===== FRONTEND ADMIN (React App) =====
  oppsys-admin:
    container_name: oppsys-v2-oppsys-admin-1
    build:
      context: .
      dockerfile: apps/admin/Dockerfile
      args:
        NODE_ENV: ${NODE_ENV:-production}
        #  React App : Variables REACT_APP_ passées au build
        VITE_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
        VITE_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
        VITE_ADMIN_EMAIL: ${ADMIN_EMAIL:xxxxxxxxxxxxxxxxxxxx}
        VITE_ADMIN_API_URL: https://${API_DOMAIN:-api.oppsys.io}
        VITE_DEMO_MODE: ${DEMO_MODE:-true}
    environment:
      #  Vite : Variables d'environnement pour le runtime
      - NODE_ENV=${NODE_ENV:-production}
      - VITE_SUPABASE_URL=${NEXT_PUBLIC_SUPABASE_URL}
      - VITE_SUPABASE_ANON_KEY=${NEXT_PUBLIC_SUPABASE_ANON_KEY}
      - VITE_ADMIN_EMAIL=${ADMIN_EMAIL:xxxxxxxxxxxxxxxxxxxx}
      - VITE_ADMIN_API_URL=https://${API_DOMAIN:-api.oppsys.io}
      - VITE_DEMO_MODE=${DEMO_MODE:-true}
    networks:
      - oppsys-network
    restart: unless-stopped
    depends_on:
      - oppsys-api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin.rule=Host(`xxxxxxxxxxxxxxxxxxxx`)"
      - "traefik.http.routers.admin.entrypoints=websecure"
      - "traefik.http.routers.admin.tls.certresolver=letsencrypt"
      - "traefik.http.services.admin.loadbalancer.server.port=80"
      - "traefik.docker.network=docker_oppsys-network"

  # ===== N8N (WORKFLOWS) =====
  n8n:
    image: n8nio/n8n:2.0.2
    container_name: n8n-stack-n8n-1
    restart: unless-stopped
    environment:
      - N8N_HOST=xxxxxxxxxxxxxxxxxxxx
      - N8N_PORT=xxxxxxxxxxxxxxxxxxxx
      - N8N_PROTOCOL=https
      - WEBHOOK_URL=https://n8n.oppsys.io/
      - NODE_ENV=production

      - N8N_EDITOR_BASE_URL=https://n8n.oppsys.io
      - N8N_ALLOWED_ORIGIN=https://n8n.oppsys.io

      - N8N_PUSH_BACKEND=websocket
      - N8N_DISABLE_RATE_LIMITING=true

      - N8N_TRUST_PROXY=1
      - N8N_SECURE_COOKIE=true

      - N8N_ENCRYPTION_KEY=xxxxxxxxxxxxxxxxxxxx
      - N8N_USER_MANAGEMENT_JWT_SECRET=xxxxxxxxxxxxxxxxxxxx
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=nxxxxxxxxxxxxxxxxxxxx1
      - DB_POSTGRESDB_PORT=xxxxxxxxxxxxxxxxxxxx
      - DB_POSTGRESDB_DATABASE=n8n
      - DB_POSTGRESDB_USER=xxxxxxxxxxxxxxxxxxxx
      - DB_POSTGRESDB_PASSWORD=xxxxxxxxxxxxxxxxxxxx

      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=true
      - N8N_RUNNERS_ENABLED=true
      - NODE_FUNCTION_ALLOW_EXTERNAL=axios,lodash,moment,turndown

      #  NOUVELLES VARIABLES pour gros fichiers
      - N8N_PAYLOAD_SIZE_MAX=500 # 500MB max payload
      - N8N_BINARY_DATA_MODE=filesystem # Stocker sur disque (pas en mémoire)
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem
      - N8N_BINARY_DATA_BUFFER_SIZE=16384 # 16KB buffer size
      - N8N_WEBHOOK_TIMEOUT_MIN=120 # 2 minutes timeout webhook
      - N8N_EXECUTIONS_TIMEOUT=3600 # 1h timeout exécution
      - N8N_EXECUTIONS_TIMEOUT_MAX=7200 # 2h timeout max

      # VARIABLES POUR LES AGENTS
      - N8N_AI_AGENT_TIMEOUT=600 # 10 minutes pour les agents AI
      - EXECUTIONS_TIMEOUT=600 # 10 minutes timeout général
      - EXECUTIONS_PROCESS=main # Exécuter dans le process principal
      - N8N_CONCURRENCY_PRODUCTION_LIMIT=10 # Limite de concurrence

      # VARIABLES POUR LE TASK RUNNER
      - N8N_RUNNERS_TASK_REQUEST_TIMEOUT=300000 # 5 minutes (en millisecondes)
      - N8N_RUNNERS_MAX_CONCURRENCY=10 # Max 10 tâches en parallèle
      - N8N_RUNNERS_TASK_TIMEOUT=600000 # 10 minutes timeout par tâche
      - N8N_RUNNERS_HEARTBEAT_INTERVAL=30000 # Heartbeat toutes les 30s

      #  Paramètres Node.js pour gros fichiers
      - NODE_OPTIONS=--max-old-space-size=4096 --max-http-header-size=65536

      #  NOUVELLES VARIABLES D'AUTHENTIFICATION WEBHOOK
      - N8N_WEBHOOK_AUTH_USER=${N8N_WEBHOOK_AUTH_USER:xxxxxxxxxxxxxxxxxxxx}
      - N8N_WEBHOOK_AUTH_PASS=${N8N_WEBHOOK_AUTH_PASS:xxxxxxxxxxxxxxxxxxxx
      - N8N_WEBHOOK_SECURITY_ENABLED=${N8N_WEBHOOK_SECURITY_ENABLED:-true}

      # ===== REDIS MCP CONFIGURATION =====
      - N8N_REDIS_HOST=redis
      - N8N_REDIS_PORT=xxxxxxxxxxxxxxxxxxxx
      - N8N_REDIS_PASSWORD=${REDIS_PASSWORD:xxxxxxxxxxxxxxxxxxxx}
      - N8N_REDIS_DB=0

      # Configuration Redis pour n8n (Queue et Cache)
      - QUEUE_BULL_REDIS_HOST=redis
      - QUEUE_BULL_REDIS_PORT=xxxxxxxxxxxxxxxxxxxx
      - QUEUE_BULL_REDIS_PASSWORD=${REDIS_PASSWORD:xxxxxxxxxxxxxxxxxxxx}
      - QUEUE_BULL_REDIS_DB=0
      - N8N_CACHE_BACKEND=redis
    depends_on:
      - redis
    volumes:
      - n8n_data:/home/node/.n8n
    networks:
      - oppsys-network
      - n8n-stack-network

    #  Limites de ressources Docker
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "2.0"
        reservations:
          memory: 1G
          cpus: "0.5"

    #  Ulimits pour gros fichiers
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
      nproc: 4096

    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.n8n.rule=Host(`n8n.oppsys.io`)"
      - "traefik.http.routers.n8n.entrypoints=websecure"
      - "traefik.http.routers.n8n.tls.certresolver=letsencrypt"
      - "traefik.http.services.n8n.loadbalancer.server.port=xxxxxxxxxxxxxxxxxxxx"
      - "traefik.docker.network=docker_oppsys-network"

  # ===== BACKEND API UNIFIÉ =====
  oppsys-api:
    container_name: oppsys-v2-api
    build:
      context: .
      dockerfile: apps/api/Dockerfile
      target: ${TARGET:-prod} # change with "build" in case we want to have docker for "dev" and "prod"
    ports:
      - "4000:4000"
    env_file:
      - ./apps/api/.env.prod
    networks:
      - oppsys-network
    restart: unless-stopped
    healthcheck:
      disable: true
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.oppsys.io`)"
      - "traefik.http.routers.api.entrypoints=websecure"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.services.api.loadbalancer.server.port=4000"
      - "traefik.docker.network=docker_oppsys-network"

  # ===== FRONTEND CLIENT (React App) =====
  oppsys-client:
    container_name: oppsys-v2-client
    build:
      context: .
      dockerfile: apps/client/Dockerfile
      target: ${TARGET:-prod}
      args:
        VITE_SUPABASE_URL: ${VITE_SUPABASE_URL}
        VITE_SUPABASE_ANON_KEY: ${VITE_SUPABASE_ANON_KEY}
        VITE_API_URL: ${VITE_API_URL}
    env_file:
      - ./apps/client/.env.prod
    networks:
      - oppsys-network
    restart: unless-stopped
    depends_on:
      - oppsys-api
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.client.rule=Host(`app.oppsys.io`)"
      - "traefik.http.routers.client.entrypoints=websecure"
      - "traefik.http.routers.client.tls.certresolver=letsencrypt"
      - "traefik.http.services.client.loadbalancer.server.port=80"
      - "traefik.docker.network=docker_oppsys-network"

  # ===== REVERSE PROXY =====
  traefik:
    image: traefik:v2.11
    container_name: traefik
    environment:
      - DOCKER_API_VERSION=1.44
    command:
      - "--api.dashboard=false"
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--providers.docker.network=docker_oppsys-network"
      - "--providers.docker.endpoint=unix:///var/run/docker.sock"
      - "--providers.docker.httpClientTimeout=300s"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge=true"
      - "--certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web"
      - "--certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-contact@oppsys.io}"
      - "--certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--log.level=DEBUG"
      - "--providers.file.filename=/dynamic_conf.yml"
      - "--providers.file.watch=true"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_letsencrypt:/letsencrypt
      - /home/ronan/n8n-stack/traefik/dynamic_conf.yml:/dynamic_conf.yml:ro
    networks:
      - oppsys-network
      - n8n-stack-network
    restart: unless-stopped

volumes:
  redis_mcp_data:
  n8n_data:
  traefik_letsencrypt:
  postgres_data:
  n8n-stack_n8n_data:
    external: true

networks:
  oppsys-network:
    external: true
    name: docker_oppsys-network
  n8n-stack-network:
    external: true
    name: n8n-stack-network