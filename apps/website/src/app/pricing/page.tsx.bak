// apps/website/src/app/pricing/page.tsx
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import { CheckCircle, XCircle } from 'lucide-react'

// ‚úÖ TYPES SIMPLIFI√âS
interface Plan {
  id: string
  name: string
  price: number | string
  lookup_key: string
  popular?: boolean
  features: Array<{ text: string; included: boolean }>
  priceId?: string
}

interface FeatureItemProps {
  included: boolean
  text: string
}

const FeatureItem = ({ included, text }: FeatureItemProps) => (
  <li className="flex items-start mb-3">
    <span className={`mr-2 mt-1 ${included ? 'text-green-500' : 'text-gray-400'}`}>
      {included ? (
        <CheckCircle className="w-4 h-4" />
      ) : (
        <XCircle className="w-4 h-4" />
      )}
    </span>
    <span className={included ? 'text-gray-800' : 'text-gray-500'}>{text}</span>
  </li>
)

export default function PricingPage() {
  const [plans, setPlans] = useState<Plan[]>([])
  const [isLoading, setIsLoading] = useState(true)
  const [error, setError] = useState<string | null>(null)
  const [email, setEmail] = useState('')
  const [selectedPlan, setSelectedPlan] = useState<string | null>(null)
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [emailError, setEmailError] = useState('')
  const router = useRouter()

  useEffect(() => {
    const fetchPlans = async () => {
      try {
        const apiBase = process.env.NEXT_PUBLIC_API_URL || 'https://api.oppsys.io'
        const res = await fetch(`${apiBase}/api/stripe/plans`)

        if (!res.ok) {
          throw new Error(`Erreur API plans: ${res.status} - ${res.statusText}`)
        }

        const data = await res.json()

        const enrichedPlans = data
          .filter((plan: any) => plan.id !== 'entreprise')
          .map((p: any) => ({
            ...p,
            popular: p.name === 'Standard',
            features: getFeaturesByPlanType(p.name?.toLowerCase() || 'free'),
            lookup_key: p.lookup_key || `plan_${p.name?.toLowerCase()}`
          }))

        setPlans(enrichedPlans)
      } catch (err) {
        console.error('Erreur r√©cup√©ration plans:', err)

        const defaultPlans = [
          {
            id: 'free',
            name: 'Plan Gratuit',
            price: 0,
            description: 'Plan gratuit avec fonctionnalit√©s de base',
            features: getFeaturesByPlanType('free'),
            lookup_key: 'plan_free'
          },
          {
            id: 'solo',
            name: 'Solo',
            price: 12,
            description: 'Pour les cr√©ateurs ind√©pendants',
            popular: false,
            features: getFeaturesByPlanType('solo'),
            lookup_key: 'plan_solo'
          },
          {
            id: 'standard',
            name: 'Standard',
            price: 25,
            description: 'Pour les petites √©quipes',
            features: getFeaturesByPlanType('standard'),
            lookup_key: 'plan_standard'
          },
          {
            id: 'premium',
            name: 'Premium',
            price: 65,
            description: 'Pour les √©quipes',
            popular: true,
            features: getFeaturesByPlanType('premium'),
            lookup_key: 'plan_premium'
          },
        ]

        setPlans(defaultPlans)
      } finally {
        setIsLoading(false)
      }
    }

    fetchPlans()
  }, [])

  const getFeaturesByPlanType = (planType: string) => {
    switch (planType) {
      case 'free':
        return [
          { text: 'Toutes les applications', included: true },
          { text: '300 cr√©dits par mois', included: true },
          { text: 'Fonctionnalit√©s de base', included: true },
          { text: 'Support communautaire', included: true },
          { text: 'Support prioritaire', included: false },
          { text: 'Int√©grations avanc√©es', included: false }
        ];
      case 'solo':
        return [
          { text: 'Toutes les applications', included: true },
          { text: '1200 cr√©dits par mois', included: true },
          { text: 'Toutes les fonctionnalit√©s', included: true },
          { text: 'Support par email', included: true },
          { text: 'Int√©grations de base', included: true },
          { text: 'Analytics avanc√©es', included: false }
        ];
      case 'standard':
        return [
          { text: 'Toutes les applications', included: true },
          { text: '3000 cr√©dits par mois', included: true },
          { text: 'Toutes les fonctionnalit√©s', included: true },
          { text: 'Support prioritaire', included: true },
          { text: 'Toutes les int√©grations', included: true },
          { text: 'Analytics avanc√©es', included: true }
        ];
      case 'premium':
        return [
          { text: 'Toutes les applications', included: true },
          { text: '9000 cr√©dits par mois', included: true },
          { text: 'Fonctionnalit√©s premium', included: true },
          { text: 'Support prioritaire 24/7', included: true },
          { text: 'Int√©grations personnalis√©es', included: true },
          { text: 'Formation et onboarding', included: true }
        ];
      default:
        return [
          { text: 'Fonctionnalit√©s de base', included: true },
          { text: 'Support standard', included: true }
        ];
    }
  };

  const validateEmail = (email: string) => {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
    return re.test(email)
  }

  const handleSubscribe = async (planId: string, lookup_key: string) => {
    console.log(`Demande d'abonnement au plan: ${planId} (${lookup_key})`)
    setSelectedPlan(planId)

    if (email && validateEmail(email)) {
      console.log('Email d√©j√† fourni, traitement du plan')
      await createCheckoutSession(planId, email, lookup_key)
    } else {
      console.log('Affichage du formulaire email')
    }
  }

  const handleEmailSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    console.log('Soumission du formulaire email')

    if (!validateEmail(email)) {
      console.log('Email invalide:', email)
      setEmailError('Veuillez saisir une adresse email valide')
      return
    }

    setEmailError('')

    const selectedPlanData = plans.find(p => p.id === selectedPlan)
    const lookup_key = selectedPlanData ? selectedPlanData.lookup_key : null
    console.log('Plan s√©lectionn√©:', selectedPlan, 'Lookup key:', lookup_key)

    if (selectedPlan && lookup_key) {
      await createCheckoutSession(selectedPlan, email, lookup_key)
    }
  }

  // ‚úÖ CORRECTION MAJEURE : Redirection vers login pour plan gratuit
  const createCheckoutSession = async (planId: string, email: string, lookup_key: string) => {
    setIsSubmitting(true)
    console.log('üîÑ Cr√©ation de la session:', { planId, email, lookup_key })

    try {
      // ‚úÖ SOLUTION : Plan gratuit ‚Üí Redirection vers login avec params
      if (planId === 'bf1bfc2d-0b1c-44f4-9e8e-00d1d9f9d9de' ||
          planId === 'free' ||
          lookup_key === 'plan_free') {
        console.log('üÜì Plan gratuit d√©tect√© - Redirection vers login')

        // ‚úÖ REDIRECTION VERS LOGIN QUI FONCTIONNE
        const loginUrl = `https://app.oppsys.io/login?email=${encodeURIComponent(email)}&plan=free&source=pricing`

        console.log('üîó Redirection vers:', loginUrl)
        window.location.href = loginUrl
        return
      }

      // Plans payants : Stripe IDENTIQUE
      const apiBase = process.env.NEXT_PUBLIC_API_URL || 'https://api.oppsys.io'
      const apiUrl = `${apiBase}/api/stripe/create-checkout-session`

      console.log('üöÄ Envoi de la requ√™te Stripe √†:', apiUrl)
      console.log('üìä Donn√©es:', { planId, email, lookup_key })

      const response = await fetch(apiUrl, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          planId,
          email,
          lookup_key,
          source: 'pricing_page'
        }),
      })

      const responseText = await response.text()
      console.log('üìã R√©ponse brute:', responseText)

      let data
      try {
        data = JSON.parse(responseText)
      } catch (parseError) {
        console.error('‚ùå Erreur de parsing JSON:', parseError)
        throw new Error(`R√©ponse non-JSON: ${responseText.substring(0, 100)}...`)
      }

      if (!response.ok) {
        console.error('‚ùå Erreur d√©taill√©e:', data)
        throw new Error(data.error || data.details || 'Erreur lors de la cr√©ation de la session')
      }

      console.log('‚úÖ R√©ponse du serveur:', data)

      if (data.redirect) {
        console.log('üîÑ Redirection vers:', data.url)
        window.location.href = data.url
      } else if (data.url) {
        console.log('üîÑ Redirection vers Stripe:', data.url)
        window.location.href = data.url
      } else {
        console.error('‚ùå Aucune URL fournie dans la r√©ponse')
        throw new Error('Aucune URL de redirection fournie')
      }
    } catch (err: any) {
      console.error('üí• Erreur compl√®te:', err)
      setError(err.message)
    } finally {
      setIsSubmitting(false)
    }
  }

  if (isLoading) {
    return (
      <section className="py-20 bg-gray-50">
        <div className="container mx-auto px-4">
          <div className="text-center">
            <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-orange-600 mx-auto mb-4"></div>
            <p className="text-gray-600">Chargement des plans...</p>
          </div>
        </div>
      </section>
    )
  }

  return (
    <>
      {/* Hero Section */}
      <section className="py-20 bg-gradient-to-br from-blue-50 via-white to-cyan-50">
        <div className="container mx-auto px-4 text-center">
          <div className="max-w-4xl mx-auto">
            <h1 className="text-4xl md:text-5xl font-bold text-gray-900 mb-6">
              Choisissez le plan qui vous convient
            </h1>
            <p className="text-xl text-gray-600 mb-8 max-w-3xl mx-auto">
              Tous nos plans incluent l'acc√®s √† la plateforme et aux workers IA
            </p>
          </div>
        </div>
      </section>

      {/* Section des plans */}
      <section className="py-20 bg-white">
        <div className="container mx-auto px-4">
          {error && (
            <div className="mb-8 p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg max-w-4xl mx-auto">
              <p className="font-medium">Une erreur est survenue:</p>
              <p>{error}</p>
            </div>
          )}

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 max-w-7xl mx-auto">
            {plans.map((plan) => (
              <div
                key={plan.id}
                className={`bg-white rounded-2xl shadow-sm border-2 transition-all duration-300 hover:shadow-lg ${
                  plan.popular ? 'border-orange-500 transform scale-105' : 'border-gray-100 hover:border-orange-200'
                }`}
              >
                {plan.popular && (
                  <div className="bg-orange-600 text-white text-center py-2 px-4 text-sm font-semibold rounded-t-2xl">
                    RECOMMAND√â
                  </div>
                )}
                {(plan.id === 'bf1bfc2d-0b1c-44f4-9e8e-00d1d9f9d9de' || plan.name === 'Free' || plan.id === 'free') && (
                  <div className="bg-green-500 text-white text-center py-2 px-4 text-sm font-semibold rounded-t-2xl">
                    GRATUIT
                  </div>
                )}

                <div className="p-6">
                  <h2 className="text-2xl font-bold text-gray-900 mb-2">{plan.name}</h2>
                  <p className="text-gray-500 mb-6">
                    Id√©al pour {
                      (plan.id === 'bf1bfc2d-0b1c-44f4-9e8e-00d1d9f9d9de' || plan.name === 'Free' || plan.id === 'free') ? 'd√©couvrir la plateforme' :
                      plan.id === 'solo' ? 'les freelances' :
                      plan.id === 'standard' ? 'les petites √©quipes' :
                      plan.id === 'premium' ? 'les moyennes entreprises' :
                      'les professionnels'
                    }
                  </p>

                  <div className="flex items-baseline mb-8">
                    <span className="text-4xl font-extrabold text-gray-900">
                      {plan.price === 0 ? 'Gratuit' : typeof plan.price === 'string' ? plan.price : `${plan.price}‚Ç¨`}
                    </span>
                    {plan.price !== 0 && typeof plan.price !== 'string' && <span className="ml-1 text-xl text-gray-500">/mois</span>}
                  </div>

                  <button
                    onClick={() => handleSubscribe(plan.id, plan.lookup_key)}
                    className={`w-full px-4 py-3 rounded-lg font-medium text-white transition-all duration-200 ${
                      (plan.id === 'bf1bfc2d-0b1c-44f4-9e8e-00d1d9f9d9de' || plan.name === 'Free' || plan.id === 'free')
                        ? 'bg-green-600 hover:bg-green-700 transform hover:scale-105'
                        : plan.popular
                          ? 'bg-orange-600 hover:bg-orange-700 transform hover:scale-105'
                          : 'bg-gray-800 hover:bg-gray-900 transform hover:scale-105'
                    } shadow-lg`}
                  >
                    {isSubmitting && selectedPlan === plan.id
                      ? 'Chargement...'
                      : (plan.id === 'bf1bfc2d-0b1c-44f4-9e8e-00d1d9f9d9de' || plan.name === 'Free' || plan.id === 'free')
                        ? 'Commencer gratuitement'
                        : 'Choisir ce plan'
                    }
                  </button>
                </div>

                <div className="px-6 pt-2 pb-8 border-t border-gray-200 bg-gray-50 rounded-b-2xl">
                  <h3 className="text-sm font-medium text-gray-900 tracking-wide mb-4">Fonctionnalit√©s incluses</h3>
                  <ul className="space-y-3">
                    {plan.features.map((feature, index) => (
                      <FeatureItem
                        key={index}
                        included={feature.included}
                        text={feature.text}
                      />
                    ))}
                  </ul>
                </div>
              </div>
            ))}
          </div>
        </div>
      </section>

      {/* FAQ Section */}
      <section className="py-20 bg-gray-50">
        <div className="container mx-auto px-4">
          <div className="text-center mb-16">
            <h2 className="text-3xl md:text-4xl font-bold text-gray-900 mb-4">
              Questions fr√©quentes
            </h2>
          </div>

          <div className="max-w-3xl mx-auto space-y-6">
            <div className="bg-white rounded-xl p-6 hover:shadow-md transition-shadow duration-300">
              <h3 className="font-semibold text-lg text-gray-900 mb-2">
                Puis-je changer de plan ?
              </h3>
              <p className="text-gray-700 leading-relaxed">
                Oui, vous pouvez changer de plan √† tout moment. La diff√©rence de prix sera calcul√©e au prorata.
              </p>
            </div>

            <div className="bg-white rounded-xl p-6 hover:shadow-md transition-shadow duration-300">
              <h3 className="font-semibold text-lg text-gray-900 mb-2">
                Comment fonctionne la facturation ?
              </h3>
              <p className="text-gray-700 leading-relaxed">
                La facturation est mensuelle. Vous serez factur√© le m√™me jour chaque mois.
              </p>
            </div>

            <div className="bg-white rounded-xl p-6 hover:shadow-md transition-shadow duration-300">
              <h3 className="font-semibold text-lg text-gray-900 mb-2">
                Puis-je annuler mon abonnement ?
              </h3>
              <p className="text-gray-700 leading-relaxed">
                Vous pouvez annuler votre abonnement √† tout moment depuis votre tableau de bord.
              </p>
            </div>

            <div className="bg-white rounded-xl p-6 hover:shadow-md transition-shadow duration-300">
              <h3 className="font-semibold text-lg text-gray-900 mb-2">
                Y a-t-il une p√©riode d'essai ?
              </h3>
              <p className="text-gray-700 leading-relaxed">
                Nous proposons un plan gratuit avec 300 cr√©dits pour tester la plateforme.
              </p>
            </div>
          </div>
        </div>
      </section>

      {/* Modal email simplifi√© */}
      {selectedPlan && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl">
            <h3 className="text-2xl font-bold text-gray-900 mb-4">Presque termin√© !</h3>
            <p className="text-gray-600 mb-6">
              Veuillez saisir votre adresse email pour continuer
            </p>

            <form onSubmit={handleEmailSubmit} className="space-y-6">
              <div>
                <label htmlFor="email" className="block text-sm font-medium text-gray-700 mb-2">
                  Adresse email
                </label>
                <input
                  type="email"
                  id="email"
                  value={email}
                  onChange={(e) => setEmail(e.target.value)}
                  className="w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-orange-500 focus:border-orange-500"
                  placeholder="vous@exemple.com"
                  required
                />
                {emailError && (
                  <p className="mt-2 text-sm text-red-600">{emailError}</p>
                )}
              </div>

              <div className="bg-gray-50 p-4 rounded-lg">
                <p className="text-sm text-gray-700">
                  Plan s√©lectionn√©: <span className="font-semibold">
                    {plans.find(p => p.id === selectedPlan)?.name}
                  </span>
                </p>
              </div>

              <div className="flex space-x-3">
                <button
                  type="button"
                  onClick={() => setSelectedPlan(null)}
                  className="flex-1 px-4 py-3 border border-gray-300 rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors duration-200"
                >
                  Annuler
                </button>
                <button
                  type="submit"
                  className="flex-1 px-4 py-3 rounded-lg shadow-sm text-white font-medium transition-all duration-200 bg-orange-600 hover:bg-orange-700 focus:ring-orange-500 focus:outline-none focus:ring-2 focus:ring-offset-2 transform hover:scale-105"
                  disabled={isSubmitting}
                >
                  {isSubmitting
                    ? 'Redirection...'
                    : (selectedPlan === 'bf1bfc2d-0b1c-44f4-9e8e-00d1d9f9d9de' ||
                       selectedPlan === 'free' ||
                       plans.find(p => p.id === selectedPlan)?.name === 'Free')
                      ? 'Cr√©er mon compte gratuit'
                      : 'Continuer vers le paiement'
                  }
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </>
  )
}
